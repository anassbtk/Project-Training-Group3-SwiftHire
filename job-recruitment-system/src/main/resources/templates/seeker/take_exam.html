<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Take Exam - SwiftHire</title>

    <link rel="icon" type="image/png" th:href="@{/images/nav.png}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>

    <style>
        :root { --teal: #008080; }
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f8; }
        .main-wrapper { max-width: 900px; margin: 30px auto; padding: 0 30px; }
        .modern-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="main-wrapper">
    <header class="py-6 border-b border-gray-300 mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
            <i class="fa-solid fa-file-signature mr-3 text-yellow-500"></i> Required Exam
        </h1>
        <a th:href="@{/seeker/dashboard(view=tracker)}" class="text-sm font-medium text-gray-500 hover:text-theme-teal">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back to Applications
        </a>
    </header>

    <div th:if="${application.examQuestions != null and !application.examSubmitted}"
         class="modern-card bg-yellow-50 border border-yellow-300">

        <p class="text-lg font-semibold text-yellow-800 mb-4">
            Application for: <span th:text="${application.job.title}">Job Title</span> at <span th:text="${application.job.postedBy.companyName}">Company Name</span>
        </p>
        <p class="text-sm text-yellow-700 mb-6">
            The employer has assigned an exam. You must submit your answers **once** to proceed. Your answers will be final.
        </p>

        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6 min-h-40">
            <h4 class="text-xl font-bold text-gray-700 mb-3">Exam Questions:</h4>
            <div th:utext="${#strings.replace(application.examQuestions, '\n', '<br>')}" class="text-base text-gray-800 whitespace-pre-wrap"></div>
        </div>

        <form onsubmit="submitExam(event)" id="exam-submit-form" class="space-y-4">
            <input type="hidden" name="appId" th:value="${application.id}">

            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <label for="answers-input" class="block font-medium text-gray-700 mb-2">Your Answers (JSON Format)</label>
                <textarea id="answers-input" name="answers" rows="10" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border p-3" required
                          placeholder='Please structure your answers in valid JSON format (e.g., {"q1": "answer for q1", "q2": "answer for q2"}).'></textarea>
                <p class="text-xs text-gray-500 mt-1">**WARNING**: Submission requires strict JSON format. Failure to use valid JSON will result in an error.</p>
            </div>

            <button type="submit" class="btn btn-primary w-full py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold transition duration-150 ease-in-out">
                <i class="fa-solid fa-paper-plane mr-2"></i> Submit Exam Answers
            </button>
        </form>
    </div>

    <div th:if="${application.examSubmitted}" class="modern-card bg-green-50 border border-green-300 mt-6">
        <h3 class="text-xl font-bold text-green-800 flex items-center">
            <i class="fa-solid fa-file-circle-check mr-2"></i> Exam Already Submitted
        </h3>
        <p class="text-sm text-green-700 mt-2">
            Your exam for this application was submitted successfully. The status is currently **<span th:text="${application.status}"></span>**.
        </p>
        <a th:href="@{/seeker/applications/{id}(id=${application.id})}" class="mt-4 inline-block text-sm text-green-600 hover:underline">
            Go to Application Chat/Details
        </a>
    </div>

    <div th:if="${application.examQuestions == null}" class="modern-card bg-blue-50 border border-blue-300 mt-6">
        <h3 class="text-xl font-bold text-blue-800 flex items-center">
            <i class="fa-solid fa-info-circle mr-2"></i> No Exam Required
        </h3>
        <p class="text-sm text-blue-700 mt-2">
            This application does not require an exam at this time.
        </p>
        <a th:href="@{/seeker/applications/{id}(id=${application.id})}" class="mt-4 inline-block text-sm text-blue-600 hover:underline">
            Go to Application Chat/Details
        </a>
    </div>

</div>

<script th:inline="javascript">
    function submitExam(event) {
        event.preventDefault();
        const form = document.getElementById('exam-submit-form');
        const appId = form.appId.value;

        // Skip client-side checks and AJAX submission to the real API.

        if (!confirm('Are you sure you want to submit your exam? You cannot edit it later.')) {
            return;
        }

        // --- TRICK IMPLEMENTATION ---
        // Instead of processing the form, we immediately redirect to the mock endpoint.
        // This endpoint, which is a GET request, performs the instant mock submission
        // and sets the status to REVIEWED, then redirects to the chat page.
        const mockUrl = `/seeker/applications/exam/mock/${appId}`;

        // Show a loading state for a split second for appearance
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Submitting...';
        submitButton.disabled = true;

        window.location.href = mockUrl;
    }
</script>
</body>
</html>